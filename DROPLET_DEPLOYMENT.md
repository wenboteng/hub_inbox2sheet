# OTA Answer Hub - Droplet Deployment Guide

This guide provides step-by-step instructions for deploying the OTA Answer Hub application on a DigitalOcean droplet server.

## Prerequisites

- A DigitalOcean account
- A domain name (optional but recommended for SSL)
- SSH access to your droplet
- Basic knowledge of Linux command line

## Step 1: Create a DigitalOcean Droplet

1. **Create a new droplet:**
   - Choose Ubuntu 22.04 LTS
   - Select a plan with at least 2GB RAM and 1 vCPU
   - Choose a datacenter region close to your target users
   - Add your SSH key or create a password
   - Choose a hostname (e.g., `ota-answer-hub`)

2. **Recommended specifications:**
   - **Basic Plan**: 2GB RAM, 1 vCPU, 50GB SSD ($12/month)
   - **Standard Plan**: 4GB RAM, 2 vCPU, 80GB SSD ($24/month) - Recommended
   - **Premium Plan**: 8GB RAM, 4 vCPU, 160GB SSD ($48/month) - For high traffic

## Step 2: Connect to Your Droplet

```bash
ssh root@your-droplet-ip
```

## Step 3: Clone the Repository

```bash
# Create project directory
mkdir -p /root/projects
cd /root/projects

# Clone the repository
git clone https://github.com/yourusername/hub_inbox2sheet.git
cd hub_inbox2sheet
```

## Step 4: Run the Deployment Script

```bash
# Make scripts executable
chmod +x deploy.sh setup-database.sh setup-cron.sh setup-ssl.sh

# Run the main deployment script
sudo ./deploy.sh
```

This script will:
- Update system packages
- Install Node.js 18.x
- Install PM2 for process management
- Install PostgreSQL
- Install Nginx
- Install Puppeteer dependencies
- Create a `.env` template file
- Build the application
- Configure Nginx
- Start the application with PM2

## Step 5: Set Up the Database

```bash
# Run the database setup script
sudo ./setup-database.sh
```

This script will:
- Create a PostgreSQL database and user
- Enable required extensions (vector, uuid-ossp)
- Optimize PostgreSQL configuration
- Update the `.env` file with database credentials

## Step 6: Configure Environment Variables

Edit the `.env` file with your actual configuration:

```bash
nano /root/projects/hub_inbox2sheet/.env
```

**Required variables:**
```env
# Database Configuration (auto-generated by setup-database.sh)
DATABASE_URL="postgresql://ota_hub_user:password@localhost:5432/ota_hub_db"

# Application Configuration
NEXT_PUBLIC_BASE_URL="https://your-domain.com"  # Update with your domain
NODE_ENV="production"
PORT=3000

# OpenAI Configuration
OPENAI_API_KEY="your-openai-api-key"  # Required for embeddings

# Puppeteer Configuration
PUPPETEER_CACHE_DIR="/root/.cache/puppeteer"
PUPPETEER_SKIP_CHROMIUM_DOWNLOAD="false"
```

**Optional variables for OTA platform access:**
```env
# Expedia Partner Central
EXPEDIA_USERNAME=""
EXPEDIA_PASSWORD=""
EXPEDIA_SESSION_COOKIE=""

# Booking.com Partner Portal
BOOKING_API_TOKEN=""
BOOKING_SESSION_COOKIE=""
BOOKING_XSRF_TOKEN=""

# Airbnb
AIRBNB_USERNAME=""
AIRBNB_PASSWORD=""

# Reddit API
REDDIT_CLIENT_ID=""
REDDIT_CLIENT_SECRET=""
```

## Step 7: Run Database Migrations

```bash
cd /root/projects/hub_inbox2sheet

# Generate Prisma client
npx prisma generate

# Run database migrations
npx prisma migrate deploy
```

## Step 8: Set Up Cron Jobs

```bash
# Run the cron setup script
sudo ./setup-cron.sh
```

This will set up automated scraping jobs:
- Main crawler (Reddit + Airbnb): Every hour
- Secondary crawler (TripAdvisor + StackOverflow): Every 2 hours
- Tertiary crawler (Viator, GetYourGuide, Expedia, Booking): Every 4 hours
- Weekly comprehensive scraping: Every Sunday at 2 AM
- Weekly SEO optimization: Every Sunday at 4 AM
- Daily recheck: Every 6 hours
- Daily discovery: Every day at 3 AM
- Community discovery: Every 12 hours
- Analytics generation: Every Monday at 6 AM

## Step 9: Set Up SSL (Optional but Recommended)

If you have a domain name:

1. **Point your domain to the droplet:**
   - Add an A record pointing to your droplet's IP address
   - Wait for DNS propagation (can take up to 24 hours)

2. **Set up SSL certificate:**
```bash
sudo ./setup-ssl.sh your-domain.com
```

## Step 10: Restart the Application

```bash
# Restart the application with new environment variables
cd /root/projects/hub_inbox2sheet
pm2 restart ota-answer-hub
```

## Step 11: Verify Deployment

1. **Check application status:**
```bash
pm2 status
pm2 logs ota-answer-hub
```

2. **Check Nginx status:**
```bash
systemctl status nginx
nginx -t
```

3. **Check database connection:**
```bash
cd /root/projects/hub_inbox2sheet
npm run test:db
```

4. **Access your application:**
   - Without domain: `http://your-droplet-ip`
   - With domain: `https://your-domain.com`

## Management Commands

### Application Management
```bash
# View application status
pm2 status

# View application logs
pm2 logs ota-answer-hub

# Restart application
pm2 restart ota-answer-hub

# Stop application
pm2 stop ota-answer-hub

# Start application
pm2 start ota-answer-hub
```

### Database Management
```bash
# Access PostgreSQL
sudo -u postgres psql

# Run Prisma commands
cd /root/projects/hub_inbox2sheet
npx prisma studio  # Database GUI
npx prisma migrate dev  # Create new migration
npx prisma migrate deploy  # Apply migrations
```

### Cron Job Management
```bash
# View cron jobs
crontab -l

# Edit cron jobs
crontab -e

# View cron logs
tail -f /var/log/ota-hub-*.log
```

### Nginx Management
```bash
# Test configuration
nginx -t

# Reload configuration
systemctl reload nginx

# Restart Nginx
systemctl restart nginx

# View Nginx logs
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

### SSL Management
```bash
# Check certificate status
certbot certificates

# Renew certificate manually
certbot renew

# View certificate details
openssl s_client -connect your-domain.com:443 -servername your-domain.com
```

## Monitoring and Maintenance

### System Monitoring
```bash
# Check system resources
htop
df -h
free -h

# Check application logs
pm2 logs ota-answer-hub --lines 100

# Check cron job logs
tail -f /var/log/ota-hub-*.log
```

### Backup Strategy
```bash
# Database backup
pg_dump -U ota_hub_user -h localhost ota_hub_db > backup_$(date +%Y%m%d_%H%M%S).sql

# Application backup
tar -czf app_backup_$(date +%Y%m%d_%H%M%S).tar.gz /root/projects/hub_inbox2sheet
```

### Updates and Maintenance
```bash
# Update system packages
apt update && apt upgrade -y

# Update application
cd /root/projects/hub_inbox2sheet
git pull origin main
npm install
npx prisma generate
npm run build
pm2 restart ota-answer-hub
```

## Troubleshooting

### Common Issues

1. **Application won't start:**
   - Check logs: `pm2 logs ota-answer-hub`
   - Verify environment variables: `cat .env`
   - Check database connection: `npm run test:db`

2. **Database connection issues:**
   - Check PostgreSQL status: `systemctl status postgresql`
   - Verify database exists: `sudo -u postgres psql -l`
   - Check user permissions: `sudo -u postgres psql -d ota_hub_db -c "\du"`

3. **Nginx issues:**
   - Test configuration: `nginx -t`
   - Check logs: `tail -f /var/log/nginx/error.log`
   - Verify port 80/443 is open: `netstat -tlnp`

4. **Cron jobs not running:**
   - Check cron service: `systemctl status cron`
   - View cron logs: `tail -f /var/log/ota-hub-*.log`
   - Verify cron jobs: `crontab -l`

5. **SSL certificate issues:**
   - Check certificate status: `certbot certificates`
   - Verify domain DNS: `nslookup your-domain.com`
   - Check firewall: `ufw status`

### Performance Optimization

1. **Database optimization:**
   - Monitor slow queries: `sudo -u postgres psql -d ota_hub_db -c "SELECT * FROM pg_stat_statements ORDER BY mean_time DESC LIMIT 10;"`
   - Analyze table statistics: `ANALYZE;`

2. **Application optimization:**
   - Monitor memory usage: `pm2 monit`
   - Check for memory leaks: `pm2 logs ota-answer-hub --lines 1000 | grep -i memory`

3. **System optimization:**
   - Monitor disk usage: `df -h`
   - Check for large log files: `find /var/log -name "*.log" -size +100M`

## Security Considerations

1. **Firewall setup:**
```bash
# Install and configure UFW
apt install ufw
ufw allow ssh
ufw allow 'Nginx Full'
ufw enable
```

2. **Regular updates:**
```bash
# Set up automatic security updates
apt install unattended-upgrades
dpkg-reconfigure -plow unattended-upgrades
```

3. **Database security:**
   - Use strong passwords
   - Limit database access to localhost only
   - Regular backups

4. **Application security:**
   - Keep dependencies updated
   - Use environment variables for secrets
   - Regular security audits

## Support

For issues and questions:
1. Check the logs first
2. Review this documentation
3. Check the application's README.md
4. Review the troubleshooting section above

## Cost Estimation

**Monthly costs for a standard deployment:**
- DigitalOcean Droplet (2GB RAM, 1 vCPU): $12/month
- Domain name: $10-15/year
- Total: ~$13-14/month

**For higher traffic:**
- DigitalOcean Droplet (4GB RAM, 2 vCPU): $24/month
- Domain name: $10-15/year
- Total: ~$25-26/month 